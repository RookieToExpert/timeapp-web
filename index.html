<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>World Time for Ray</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0b1220;color:#e6edf3}
    header,main{max-width:900px;margin:0 auto;padding:24px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:16px;margin:12px 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    input,button{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#e6edf3}
    button{cursor:pointer}
    .muted{color:#9ca3af}
    .hidden{display:none}
  </style>
</head>
<body>
<header>
  <h2>World Time</h2>
  <div id="notice" class="muted"></div>
</header>

<main>
  <section id="login-card" class="card">
    <h3>登录</h3>
    <form id="login-form">
      <div><input id="email" type="email" placeholder="Email" required style="width:100%"></div><br/>
      <div><input id="password" type="password" placeholder="Password" required style="width:100%"></div><br/>
      <button type="submit">登录</button>
    </form>
  </section>

  <section id="dash" class="hidden">
    <div class="card"><b>总浏览量：</b><span id="total">--</span></div>
    <div class="grid" id="times"></div>
    <div class="card">
      <button id="refresh">刷新时间</button>
      <button id="logout" style="margin-left:8px;">退出登录</button>
    </div>
  </section>
</main>

<script>
const zones = [
  {label:'New York', tz:'America/New_York'},
  {label:'Beijing', tz:'Asia/Shanghai'},
  {label:'Sydney', tz:'Australia/Sydney'},
  {label:'Delhi', tz:'Asia/Kolkata'},
];

function fmtNow(tz){
  const d = new Date();
  return new Intl.DateTimeFormat('en-GB',{
    dateStyle:'medium', timeStyle:'medium', timeZone: tz
  }).format(d);
}

async function api(path, opts={}){
  try{
    const r = await fetch(path, {credentials:'include', ...opts});
    if(!r.ok) throw new Error(r.status);
    return await r.json();
  }catch(e){
    return null; // 后端未就绪时返回 null
  }
}

function renderTimes(list){
  const box = document.getElementById('times');
  box.innerHTML = '';
  list.forEach(x=>{
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `<b>${x.label}</b><div class="muted">${x.tz}</div><div>${x.text}</div>`;
    box.appendChild(el);
  });
}

async function loadTimes(){
  // 优先尝试后端接口
  const data = await api('/api/time/now');
  if(data?.times){
    renderTimes(data.times.map(t=>({label:t.label, tz:t.tz, text:new Date(t.iso).toLocaleString()})));
  }else{
    // 本地计算兜底（便于前端先开发）
    renderTimes(zones.map(z=>({label:z.label, tz:z.tz, text: fmtNow(z.tz)})));
    document.getElementById('notice').textContent = '后端未连接，已使用本地时间兜底';
  }
}

async function loadCounter(){
  const data = await api('/api/metrics/total');
  document.getElementById('total').textContent = (data && typeof data.total==='number') ? data.total : '—';
}

async function postVisit(){
  await api('/api/metrics/visit', {method:'POST'});
}

function showDash(on){
  document.getElementById('login-card').classList.toggle('hidden', on);
  document.getElementById('dash').classList.toggle('hidden', !on);
}

document.getElementById('login-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const ok = await api('/api/auth/login', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({email, password})
  });
  if(ok && ok.ok){
    showDash(true);
    await postVisit();
    await loadTimes();
    await loadCounter();
  }else{
    alert('登录失败（让唐睿给你加账号）');
  }
});

document.getElementById('refresh').onclick = loadTimes;
document.getElementById('logout').onclick = ()=>{ showDash(false); };

</script>
</body>
</html>